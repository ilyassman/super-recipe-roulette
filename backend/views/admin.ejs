<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Super Recipe Roulette</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!-- CSS spécifique à la page admin -->
    <link rel="stylesheet" href="/assets/css/admin.css">
</head>
<body class="admin-page-body">
    <!-- Header / Navigation -->
    <%- include('partials/navbar', { activePage: 'admin', logged: logged, userRole: userRole }) %>

    <!-- Main Content -->
    <main class="admin-page-main">
        <div class="container">
            <!-- En-tête -->
            <div class="admin-header d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="fw-bold mb-2">
                        <i class="bi bi-shield-lock me-2 text-primary"></i>
                        Administration des Recettes
                    </h1>
                    <p class="text-muted mb-0">Bienvenue, <%= userName %>. Gérez toutes les recettes de la plateforme.</p>
                </div>
                <button type="button" class="btn admin-add-btn" data-bs-toggle="modal" data-bs-target="#addRecipeModal">
                    <i class="bi bi-plus-circle me-2"></i>Ajouter une recette
                </button>
            </div>

            <!-- Messages de succès/erreur -->
            <% if (typeof query !== 'undefined' && query.success) { %>
                <div class="alert alert-success admin-alert alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i><%= query.success %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>
            <% if (typeof query !== 'undefined' && query.error) { %>
                <div class="alert alert-danger admin-alert alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i><%= query.error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>
            <% if (error) { %>
                <div class="alert alert-danger admin-alert alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i><%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>

            <!-- Tableau des recettes -->
            <div class="card admin-table-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Liste des recettes 
                        <% if (typeof pagination !== 'undefined' && pagination) { %>
                            (<%= pagination.total %> au total)
                        <% } else { %>
                            (<%= recipes.length %>)
                        <% } %>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <% if (recipes.length === 0) { %>
                        <div class="admin-empty-state">
                            <i class="bi bi-inbox"></i>
                            <h4 class="text-muted">Aucune recette</h4>
                            <p class="text-muted">Commencez par ajouter une recette.</p>
                            <button type="button" class="btn admin-add-btn" data-bs-toggle="modal" data-bs-target="#addRecipeModal">
                                <i class="bi bi-plus-circle me-2"></i>Ajouter une recette
                            </button>
                        </div>
                    <% } else { %>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Image</th>
                                        <th>Titre</th>
                                        <th>Catégorie</th>
                                        <th>Temps</th>
                                        <th>Difficulté</th>
                                        <th>Portions</th>
                                        <th>Date création</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% recipes.forEach(function(recipe) { %>
                                        <tr>
                                            <td><%= recipe.id %></td>
                                            <td>
                                                <% if (recipe.image) { %>
                                                    <% 
                                                        // Normaliser le nom d'image (extraire uniquement le nom du fichier)
                                                        let imageName = recipe.image;
                                                        // Si le chemin contient déjà /assets/ ou http, utiliser tel quel
                                                        if (imageName.includes('/assets/') || imageName.startsWith('http')) {
                                                            // Extraire juste le nom du fichier depuis le chemin
                                                            const parts = imageName.split(/[/\\]/);
                                                            imageName = parts[parts.length - 1];
                                                        } else if (imageName.includes('/') || imageName.includes('\\')) {
                                                            // Si c'est un chemin relatif, extraire juste le nom
                                                            const parts = imageName.split(/[/\\]/);
                                                            imageName = parts[parts.length - 1];
                                                        }
                                                        // Construire l'URL : toutes les images sont dans /assets/img/
                                                        let imageUrl = '/assets/img/' + imageName;
                                                    %>
                                                    <img src="<%= imageUrl %>"
                                                    alt="<%= recipe.titre %>"
                                                    class="img-thumbnail"
                                                    style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;"
                                                    onerror="this.hidden=true; this.nextElementSibling.hidden=false;">
                                               
                                               <div hidden
                                                    class="align-items-center justify-content-center"
                                                    style="width: 60px; height: 60px; background-color: #f3f4f6; border-radius: 8px; display:flex;">
                                                   <i class="bi bi-image text-muted"></i>
                                               </div>
                                               
                                                <% } else { %>
                                                    <div class="d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background-color: #f3f4f6; border-radius: 8px;">
                                                        <i class="bi bi-image text-muted"></i>
                                                    </div>
                                                <% } %>
                                            </td>
                                            <td>
                                                <strong><%= recipe.titre %></strong>
                                                <% if (recipe.description) { %>
                                                    <br><small class="text-muted"><%= recipe.description.substring(0, 50) %><%= recipe.description.length > 50 ? '...' : '' %></small>
                                                <% } %>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    <%= recipe.categorie === 'entree' ? 'Entrée' : recipe.categorie === 'plat' ? 'Plat' : 'Dessert' %>
                                                </span>
                                            </td>
                                            <td>
                                                <% if (recipe.temps_preparation) { %>
                                                    <i class="bi bi-clock me-1"></i><%= recipe.temps_preparation %> min
                                                <% } else { %>
                                                    <span class="text-muted">N/A</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (recipe.difficulte) { %>
                                                    <% 
                                                        let badgeClass = 'bg-success';
                                                        if (recipe.difficulte === 'Moyen') badgeClass = 'bg-warning text-dark';
                                                        if (recipe.difficulte === 'Difficile') badgeClass = 'bg-danger';
                                                    %>
                                                    <span class="badge <%= badgeClass %>"><%= recipe.difficulte %></span>
                                                <% } else { %>
                                                    <span class="text-muted">N/A</span>
                                                <% } %>
                                            </td>
                                            <td><%= recipe.portions_defaut || 4 %></td>
                                            <td>
                                                <small class="text-muted">
                                                    <%= new Date(recipe.date_creation).toLocaleDateString('fr-FR') %>
                                                </small>
                                            </td>
                                            <td class="text-end">
                                                <div class="admin-action-buttons">
                                                    <button type="button" 
                                                            class="btn btn-sm admin-action-btn admin-action-btn-edit js-open-edit-modal" 
                                                            title="Modifier"
                                                            data-recipe-id="<%= recipe.id %>">
                                                        <i class="bi bi-pencil me-1"></i>Modifier
                                                    </button>
                                                    <a href="/admin/delete/<%= recipe.id %>" 
                                                       class="btn btn-sm admin-action-btn admin-action-btn-delete" 
                                                       title="Supprimer"
                                                       onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette recette ? Cette action est irréversible.');">
                                                        <i class="bi bi-trash me-1"></i>Supprimer
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Pagination -->
            <% if (typeof pagination !== 'undefined' && pagination && pagination.totalPages > 1) { %>
                <nav aria-label="Pagination admin" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <!-- Flèche précédente -->
                        <% if (pagination.currentPage > 1) { %>
                            <li class="page-item">
                                <a class="page-link" href="/admin?page=<%= pagination.currentPage - 1 %>">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        <% } else { %>
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                            </li>
                        <% } %>

                        <!-- Pages -->
                        <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                            <% if (i === pagination.currentPage) { %>
                                <li class="page-item active">
                                    <span class="page-link"><%= i %></span>
                                </li>
                            <% } else { %>
                                <li class="page-item">
                                    <a class="page-link" href="/admin?page=<%= i %>"><%= i %></a>
                                </li>
                            <% } %>
                        <% } %>

                        <!-- Flèche suivante -->
                        <% if (pagination.currentPage < pagination.totalPages) { %>
                            <li class="page-item">
                                <a class="page-link" href="/admin?page=<%= pagination.currentPage + 1 %>">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        <% } else { %>
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            <% } %>
        </div>
    </main>

    <!-- Modal pour ajouter une recette -->
    <div class="modal fade admin-modal" id="addRecipeModal" tabindex="-1" aria-labelledby="addRecipeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRecipeModalLabel">
                        <i class="bi bi-plus-circle me-2 text-primary"></i>
                        Ajouter une nouvelle recette
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="/admin/add" enctype="multipart/form-data">
                    <div class="modal-body">
                        <!-- Titre -->
                        <div class="mb-3">
                            <label for="modal_titre" class="form-label admin-modal">
                                Titre <span class="text-danger">*</span>
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="modal_titre" 
                                name="titre" 
                                required
                                placeholder="Ex: Poulet rôti au citron"
                            >
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="modal_description" class="form-label admin-modal">Description</label>
                            <textarea 
                                class="form-control" 
                                id="modal_description" 
                                name="description" 
                                rows="3"
                                placeholder="Décrivez la recette..."
                            ></textarea>
                        </div>

                        <!-- Catégorie -->
                        <div class="mb-3">
                            <label for="modal_categorie" class="form-label admin-modal">
                                Catégorie <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="modal_categorie" name="categorie" required>
                                <option value="">Sélectionnez une catégorie</option>
                                <option value="entree">Entrée</option>
                                <option value="plat">Plat</option>
                                <option value="dessert">Dessert</option>
                            </select>
                        </div>

                        <!-- Temps de préparation -->
                        <div class="mb-3">
                            <label for="modal_temps_preparation" class="form-label admin-modal">Temps de préparation (minutes)</label>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="modal_temps_preparation" 
                                name="temps_preparation" 
                                min="1"
                                placeholder="Ex: 30"
                            >
                        </div>

                        <!-- Difficulté -->
                        <div class="mb-3">
                            <label for="modal_difficulte" class="form-label admin-modal">Difficulté</label>
                            <select class="form-select" id="modal_difficulte" name="difficulte">
                                <option value="">Sélectionnez une difficulté</option>
                                <option value="Facile">Facile</option>
                                <option value="Moyen">Moyen</option>
                                <option value="Difficile">Difficile</option>
                            </select>
                        </div>

                        <!-- Portions par défaut -->
                        <div class="mb-3">
                            <label for="modal_portions_defaut" class="form-label admin-modal">Portions par défaut</label>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="modal_portions_defaut" 
                                name="portions_defaut" 
                                value="4"
                                min="1"
                                placeholder="Ex: 4"
                            >
                        </div>

                        <!-- Ingrédients -->
                        <div class="mb-3">
                            <label class="form-label admin-modal">
                                Ingrédients
                            </label>
                            <div id="addIngredientsList" class="d-flex flex-column gap-2"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addIngredientBtn">
                                <i class="bi bi-plus-lg me-1"></i>Ajouter un ingrédient
                            </button>
                            <small class="form-text text-muted d-block mt-1">Nom + quantité + unité (optionnel).</small>
                        </div>

                        <!-- Instructions -->
                        <div class="mb-3">
                            <label class="form-label admin-modal">
                                Instructions
                            </label>
                            <div id="addInstructionsList" class="d-flex flex-column gap-2"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addInstructionBtn">
                                <i class="bi bi-plus-lg me-1"></i>Ajouter une étape
                            </button>
                            <small class="form-text text-muted d-block mt-1">Les étapes sont numérotées automatiquement.</small>
                        </div>

                        <!-- Image (Upload) -->
                        <div class="mb-3">
                            <label for="modal_image_add" class="form-label admin-modal">Image</label>
                            <input 
                                type="file" 
                                class="form-control" 
                                id="modal_image_add" 
                                name="image" 
                                accept="image/jpeg,image/jpg,image/png,image/webp"
                            >
                            <small class="form-text text-muted">Formats acceptés : JPG, PNG, WEBP (max 5MB)</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Ajouter la recette
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier une recette -->
    <div class="modal fade admin-modal" id="editRecipeModal" tabindex="-1" aria-labelledby="editRecipeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRecipeModalLabel">
                        <i class="bi bi-pencil me-2 text-primary"></i>
                        Modifier la recette
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" id="editRecipeForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <!-- Titre -->
                        <div class="mb-3">
                            <label for="edit_modal_titre" class="form-label admin-modal">
                                Titre <span class="text-danger">*</span>
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="edit_modal_titre" 
                                name="titre" 
                                required
                                placeholder="Ex: Poulet rôti au citron"
                            >
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="edit_modal_description" class="form-label admin-modal">Description</label>
                            <textarea 
                                class="form-control" 
                                id="edit_modal_description" 
                                name="description" 
                                rows="3"
                                placeholder="Décrivez la recette..."
                            ></textarea>
                        </div>

                        <!-- Catégorie -->
                        <div class="mb-3">
                            <label for="edit_modal_categorie" class="form-label admin-modal">
                                Catégorie <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="edit_modal_categorie" name="categorie" required>
                                <option value="">Sélectionnez une catégorie</option>
                                <option value="entree">Entrée</option>
                                <option value="plat">Plat</option>
                                <option value="dessert">Dessert</option>
                            </select>
                        </div>

                        <!-- Temps de préparation -->
                        <div class="mb-3">
                            <label for="edit_modal_temps_preparation" class="form-label admin-modal">Temps de préparation (minutes)</label>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="edit_modal_temps_preparation" 
                                name="temps_preparation" 
                                min="1"
                                placeholder="Ex: 30"
                            >
                        </div>

                        <!-- Difficulté -->
                        <div class="mb-3">
                            <label for="edit_modal_difficulte" class="form-label admin-modal">Difficulté</label>
                            <select class="form-select" id="edit_modal_difficulte" name="difficulte">
                                <option value="">Sélectionnez une difficulté</option>
                                <option value="Facile">Facile</option>
                                <option value="Moyen">Moyen</option>
                                <option value="Difficile">Difficile</option>
                            </select>
                        </div>

                        <!-- Portions par défaut -->
                        <div class="mb-3">
                            <label for="edit_modal_portions_defaut" class="form-label admin-modal">Portions par défaut</label>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="edit_modal_portions_defaut" 
                                name="portions_defaut" 
                                min="1"
                                placeholder="Ex: 4"
                            >
                        </div>

                        <!-- Image actuelle -->
                        <div class="mb-3" id="edit_current_image_container" style="display: none;">
                            <label class="form-label admin-modal">Image actuelle</label>
                            <div>
                                <img id="edit_current_image" src="" alt="Image actuelle" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                            </div>
                        </div>

                        <!-- Image (Upload) -->
                        <div class="mb-3">
                            <label for="edit_modal_image" class="form-label admin-modal">Nouvelle image</label>
                            <input 
                                type="file" 
                                class="form-control" 
                                id="edit_modal_image" 
                                name="image" 
                                accept="image/jpeg,image/jpg,image/png,image/webp"
                            >
                            <small class="form-text text-muted">Laisser vide pour conserver l'image actuelle. Formats acceptés : JPG, PNG, WEBP (max 5MB)</small>
                        </div>

                        <!-- Ingrédients -->
                        <div class="mb-3">
                            <label class="form-label admin-modal">
                                Ingrédients
                            </label>
                            <div id="editIngredientsList" class="d-flex flex-column gap-2"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="editIngredientBtn">
                                <i class="bi bi-plus-lg me-1"></i>Ajouter un ingrédient
                            </button>
                            <small class="form-text text-muted d-block mt-1">Nom + quantité + unité (optionnel).</small>
                        </div>

                        <!-- Instructions -->
                        <div class="mb-3">
                            <label class="form-label admin-modal">
                                Instructions
                            </label>
                            <div id="editInstructionsList" class="d-flex flex-column gap-2"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="editInstructionBtn">
                                <i class="bi bi-plus-lg me-1"></i>Ajouter une étape
                            </button>
                            <small class="form-text text-muted d-block mt-1">Les étapes sont numérotées automatiquement.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>Enregistrer les modifications
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-12 text-center">
                    <div class="mb-3">
                        <a href="/mentions" class="text-decoration-none text-muted me-4">Mentions légales</a>
                        <a href="/contact" class="text-decoration-none text-muted me-4">Contact</a>
                        <a href="/aide" class="text-decoration-none text-muted">Aide</a>
                    </div>
                    <p class="text-muted mb-0">© 2024 Super Recipe Roulette. Tous droits réservés.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <script>
        // --- Helpers UI ingrédients / instructions ---
        function escapeHtml(str) {
            return String(str || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function addIngredientRow(listSelector, ingredient) {
            const nom = ingredient && ingredient.nom != null ? ingredient.nom : '';
            const quantite = ingredient && ingredient.quantite != null ? ingredient.quantite : '';
            const unite = ingredient && ingredient.unite != null ? ingredient.unite : '';

            const $row = $(`
                <div class="row g-2 align-items-center ingredient-row">
                    <div class="col-md-5">
                        <input type="text" class="form-control" name="ingredient_nom" placeholder="Nom (ex: Farine)" value="${escapeHtml(nom)}">
                    </div>
                    <div class="col-md-3">
                        <input type="number" step="0.01" class="form-control" name="ingredient_quantite" placeholder="Qté" value="${escapeHtml(quantite)}">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="ingredient_unite" placeholder="Unité (g, ml...)" value="${escapeHtml(unite)}">
                    </div>
                    <div class="col-md-1 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient" title="Supprimer">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            `);

            $(listSelector).append($row);
        }

        function renumberInstructions(listSelector) {
            $(listSelector).find('.instruction-row').each(function(idx) {
                $(this).find('.step-number').text(idx + 1);
            });
        }

        function addInstructionRow(listSelector, stepText) {
            const description = stepText != null ? stepText : '';

            const $row = $(`
                <div class="input-group instruction-row">
                    <span class="input-group-text step-number">1</span>
                    <textarea class="form-control" name="instruction_description" rows="2" placeholder="Décrivez l'étape...">${escapeHtml(description)}</textarea>
                    <button type="button" class="btn btn-outline-danger remove-instruction" title="Supprimer">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            `);

            $(listSelector).append($row);
            renumberInstructions(listSelector);
        }

        // Handlers globaux (add + edit)
        $(document).on('click', '.remove-ingredient', function() {
            $(this).closest('.ingredient-row').remove();
        });

        $(document).on('click', '.remove-instruction', function() {
            const $list = $(this).closest('.instruction-row').parent();
            $(this).closest('.instruction-row').remove();
            renumberInstructions($list);
        });

        // Initialisation du formulaire d'ajout (on repart propre à chaque ouverture)
        $(document).ready(function() {
            function resetAddModal() {
                $('#addIngredientsList').empty();
                $('#addInstructionsList').empty();
                addIngredientRow('#addIngredientsList');
                addInstructionRow('#addInstructionsList');
            }

            $('#addIngredientBtn').on('click', function() {
                addIngredientRow('#addIngredientsList');
            });

            $('#addInstructionBtn').on('click', function() {
                addInstructionRow('#addInstructionsList');
            });

            $('#addRecipeModal').on('shown.bs.modal', function() {
                if ($('#addIngredientsList .ingredient-row').length === 0 && $('#addInstructionsList .instruction-row').length === 0) {
                    resetAddModal();
                }
            });

            $('#addRecipeModal').on('hidden.bs.modal', function() {
                const form = $(this).find('form')[0];
                if (form) form.reset();
                resetAddModal();
            });

            // Init au chargement
            resetAddModal();
        });

        // Fonction pour ouvrir la modal d'édition et charger les données
        function openEditModal(recipeId) {
            // Réinitialiser le formulaire
            $('#editRecipeForm')[0].reset();
            $('#edit_current_image_container').hide();
            $('#editIngredientsList').empty();
            $('#editInstructionsList').empty();
            
            // Charger les données de la recette via API
            $.ajax({
                url: '/admin/api/recipe/' + recipeId,
                method: 'GET',
                success: function(recipe) {
                    // Pré-remplir le formulaire
                    $('#edit_modal_titre').val(recipe.titre || '');
                    $('#edit_modal_description').val(recipe.description || '');
                    $('#edit_modal_categorie').val(recipe.categorie || '');
                    $('#edit_modal_temps_preparation').val(recipe.temps_preparation || '');
                    $('#edit_modal_difficulte').val(recipe.difficulte || '');
                    $('#edit_modal_portions_defaut').val(recipe.portions_defaut || 4);

                    // Ingrédients (pré-remplissage)
                    if (recipe.ingredients && recipe.ingredients.length > 0) {
                        recipe.ingredients.forEach(function(ing) {
                            addIngredientRow('#editIngredientsList', ing);
                        });
                    } else {
                        addIngredientRow('#editIngredientsList');
                    }

                    // Instructions (pré-remplissage)
                    if (recipe.instructions && recipe.instructions.length > 0) {
                        recipe.instructions.forEach(function(step) {
                            addInstructionRow('#editInstructionsList', step.description || '');
                        });
                    } else {
                        addInstructionRow('#editInstructionsList');
                    }
                    
                    // Afficher l'image actuelle si elle existe
                    if (recipe.image) {
                        // Normaliser le nom d'image (extraire uniquement le nom du fichier)
                        let imageName = recipe.image;
                        // Si le chemin commence par /assets/, extraire juste le nom du fichier
                        if (imageName.startsWith('/assets/')) {
                            const parts = imageName.split('/');
                            imageName = parts[parts.length - 1];
                        } else if (imageName.includes('/') || imageName.includes('\\')) {
                            const parts = imageName.split(/[/\\]/);
                            imageName = parts[parts.length - 1];
                        }
                        // Construire l'URL : toutes les images sont dans /assets/img/
                        // Éviter les doubles chemins
                        let imageUrl = '/assets/img/' + imageName;
                        $('#edit_current_image').attr('src', imageUrl);
                        $('#edit_current_image_container').show();
                    } else {
                        $('#edit_current_image_container').hide();
                    }
                    
                    // Mettre à jour l'action du formulaire
                    $('#editRecipeForm').attr('action', '/admin/edit/' + recipeId);
                    
                    // Ouvrir la modal
                    const editModal = new bootstrap.Modal(document.getElementById('editRecipeModal'));
                    editModal.show();
                },
                error: function(xhr, status, error) {
                    console.error('Erreur lors du chargement de la recette:', error);
                    alert('Erreur lors du chargement de la recette. Veuillez réessayer.');
                }
            });
        }

        // Boutons ajouter (edit modal)
        $(document).on('click', '#editIngredientBtn', function() {
            addIngredientRow('#editIngredientsList');
        });

        $(document).on('click', '#editInstructionBtn', function() {
            addInstructionRow('#editInstructionsList');
        });

        // Ouvrir la modal d'édition depuis le tableau (sans inline JS pour éviter les soucis de parsing)
        $(document).on('click', '.js-open-edit-modal', function() {
            const recipeId = $(this).data('recipe-id');
            if (!recipeId) return;
            openEditModal(recipeId);
        });
    </script>
</body>
</html>
